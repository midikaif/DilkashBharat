<% layout('layouts/boilerplate')%>

<!-- Main Content Area -->
<div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
  <!-- Place Details Section -->
  <div class="glass bg-white/10 backdrop-blur-md border border-solid border-white/20 shadow-2xl rounded-xl overflow-hidden mb-10">
    <div class="carousel-container">
      <div class="carousel-main-images">
        <!-- Image Section -->
        <div class="w-full">
          <% if(place.images.length === 0){ %>
            <img
              id="placeImage"
              src="https://placehold.co/1200x500/065f46/ffffff?text=<%= place.title %>"
              alt="Place Image"
              class="w-full h-96 object-cover object-center rounded-t-xl"
              />
          <% }else{ %>
            <% for(let i=0; i < place.images.length; i++){ %>
            <img
              id="placeImage"
              src="<%= place.images[i]?.url || 'https://placehold.co/1200x500/065f46/ffffff?text=India'%>"
              alt="Place Image"
              class="<% if (i === 0) { %> active <% } %> w-full h-96 object-cover object-center rounded-t-xl"
              data-slide-index="<%= i + 1 %>"/>
            <% } %>
          <% } %>
        </div>

        <!-- Author Name -->
        <div
          class="absolute top-4 left-4 bg-white/80 backdrop-blur-sm text-emerald-900 text-xs font-semibold px-3 py-1 rounded-full flex items-center shadow-md border border-white/90">
          <i data-lucide="award" class="w-3 h-3 mr-1 text-emerald-600"></i>
          <span>Submitted by: <%= place.author.username %></span>

        </div>

        <!-- Thumbnails -->
        <% if(place.images.length > 1){ %>
          <div class="carousel-thumbnails">
            <% for(let i=0; i < place.images.length; i++){ %>
              <img
                class="thumbnail-item active"
                src="<%= place.images[i]?.url || 'https://placehold.co/1200x500/065f46/ffffff?text=Breathtaking+ista' %>"
                data-index="<%= i + 1 %>"
                role="button"
                aria-label="Go to slide <%= i + 1 %>"
                alt="Thumb <%= i + 1 %>"
              />
            <% } %>
          </div>
          <a class="carousel-btn prev" data-change="-1">&#10094;</a>
          <a class="carousel-btn next" data-change="1">&#10095;</a>
        <% } %>      
      </div>

    </div>

    <div class="p-6 md:p-10">
      <!-- Header -->
      <div
        class="flex justify-between items-start flex-wrap gap-4 mb-6 border-b pb-4"
      >
        <div>
          <h1
            id="placeTitle"
            class="text-2xl md:text-3xl lg:text-4xl font-extrabold text-white mb-2"
          >
            <%= place.title %>
          </h1>
          <p
            id="placeLocation"
            class="text-xl text-teal-200 font-medium flex items-center"
          >
            <i data-lucide="map-pin" class="w-5 h-5 mr-2"></i> <%=
            place.location %>
          </p>
        </div>
        <div class="text-right">
          <div
            id="averageRating"
            class="text-4xl font-bold text-amber-500 flex items-center"
          >
            <% let totalRating = 0; 
            const reviewCount = place.reviews.length;
            if(reviewCount > 0) { 
              totalRating = place.reviews.reduce((sum, review) => {
                if(review.rating){
                  return sum + review.rating 
                } else {
                  return sum
                }
              }, 0);
            const average = (totalRating / reviewCount).toFixed(1);
            const roundedAverage = Math.round(average); %>
            <%= average %> 
            <% for(let i = 1; i <= 5; i++) {
              const color = (i <= roundedAverage) ? "fill-amber-500 text-amber-500" : "text-white";
            %>
            <i data-lucide="star" class="w-6 h-6 ml-1 <%= color %>"></i>
            <% } %> 
            <% } else { %>
              0.0 
              <% for(let i = 1; i <= 5; i++) { %>
                <i data-lucide="star" class="w-6 h-6 ml-1 text-[#d1d5db]"></i>
              <% } %>
            <% } %>
          </div>
          <p id="totalReviewsCount" class="text-white text-sm">
            based on <%= place.reviews.length %> reviews
          </p>
        </div>
      </div>

      <!-- Description -->
      <div class="flex flex-col gap-4">
      <div class=" flex flex-col justify-between">
        <div class="mb-8 mr-4">
          
        <h3 class="text-2xl font-semibold text-white mb-3 border-b pb-2 pr-2">
          Description
        </h3>
        <p id="placeDescription" class="text-white leading-relaxed">
          <%= place.description %>
          </p>
        </div>
      <!-- Action Buttons -->
      <% if(currentUser && place.author.equals(currentUser._id)) {%>
      <div class="flex space-x-4">
        <a href="/places/<%= place._id %>/edit">
          <button
            class="bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md flex items-center transition"
          >
            <i data-lucide="edit" class="w-5 h-5 mr-2"></i> Edit Place
          </button>
        </a>

        <form action="/places/<%= place._id %>?_method=DELETE" method="POST">
          <button
            class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md flex items-center transition"
          >
            <i data-lucide="trash-2" class="w-5 h-5 mr-2"></i> Delete Place
          </button>
        </form>
      </div>
      <% } %>
      </div>
      
      <div id="map" style="width: 100%; height: 300px;" class="border border-gray-500"></div>
      </div>
    </div>
    
    
    </div>
  
  <!-- --- REVIEWS SECTION --- -->
  <div id="reviews" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Review Form (Left/Top) -->

    <div class="lg:col-span-1">
      <div class=" bg-white/10 
    backdrop-blur-md 
    border border-solid border-white/20 shadow-2xl rounded-xl p-6 sticky top-20">
        <h3 class="text-2xl font-bold text-white mb-4 border-b pb-2">
          Leave a Review
        </h3>
        <form
          action="/places/<%=place._id%>/reviews"
          method="post"
          id="reviewForm"
          class="space-y-4"
        >
          <!-- Rating Input -->
          <div>
            <label class="block text-white font-medium"
              >Your Rating</label>

            <div class="rating-stars mb-4">
              <input type="radio" id="star5" name="review[rating]" value="5" />
              <label for="star5" title="5 stars"></label>
              <input type="radio" id="star4" name="review[rating]" value="4" />
              <label for="star4" title="4 stars"></label>
              <input type="radio" id="star3" name="review[rating]" value="3" />
              <label for="star3" title="3 stars"></label>
              <input type="radio" id="star2" name="review[rating]" value="2" />
              <label for="star2" title="2 stars"></label>
              <input type="radio" id="star1" name="review[rating]" value="1" />
              <label for="star1" title="1 star"></label>
            </div>
          </div>

          <!-- Comment Textarea -->
          <div>
            <label for="comment" class="block text-white font-medium mb-2"
              >Comment</label
            >
            <textarea
              id="comment"
              name="review[body]"
              rows="4"
              required
              class="w-full p-3 bg-white/30  border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 transition"
            ></textarea>
          </div>

          <div id="formMessage" class="text-sm p-2 rounded-lg hidden"></div>

          <!-- Submit Button -->
          <button
            type="submit"
            class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-lg shadow-md transition transform hover:scale-[1.01] active:scale-[0.99]"
          >
            Submit Review
          </button>
        </form>
      </div>
    </div>

    <!-- Reviews List (Right/Bottom) -->
    <div class="lg:col-span-2">
      <h3 class="text-3xl font-bold text-white mb-4">User Reviews</h3>

      <!-- Review List Container -->

      <div
        id="reviewsContainer"
        class=" space-y-6 reviews-list max-h-[800px] overflow-y-auto pr-2"
      >
        <% if (place.reviews && place.reviews.length > 0) { %> <% for(const
        review of place.reviews){ %>
        <div
          class="bg-teal-600 p-5 rounded-lg border border-gray-500 shadow-sm transition hover:shadow-md review-card"
        >
          <div class="flex items-start justify-between mb-3">
            <div class="flex items-center space-x-3">
              <div
                class="bg-emerald-100 p-2 rounded-full text-emerald-600 font-bold w-10 h-10 flex items-center justify-center"
              >
                <%= review.author.username.charAt(0) %>
              </div>
              <div>
                <p class="font-semibold text-white">
                  <%= review.author.fullName.firstName %>
                </p>
                <p
                  class="text-sm text-white review-date-placeholder"
                  data-raw-date="<%= review.createdAt %>"
                ></p>
              </div>
            </div>

            <div class="flex flex-col gap-1 items-end space-y-2">
              <span
                class="review-stars-placeholder"
                data-rating="<%= review.rating %>"
              ></span>

              <% if (currentUser && review.author._id.equals(currentUser._id)) {
              %>
              <div class="flex space-x-2">
                <form
                  id="delete-form-<%= review._id %>"
                  action="/places/<%= place._id %>/reviews/<%= review._id %>?_method=DELETE"
                  method="POST"
                  class="inline"
                  onsubmit="return confirm('Are you sure you want to delete this review?')"
                >
                  <button
                    type="submit"
                    class="text-red-500 hover:text-red-700 transition p-1 rounded-full hover:bg-red-100"
                    title="Delete Review"
                  >
                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                  </button>
                </form>
              </div>
              <% } %>
            </div>
          </div>

          <% if(review.body){ %>
          <p
            class="text-white leading-relaxed italic border-t pt-3 mt-3 break-words"
          >
            "<%= review.body %>"
          </p>
          <% } %>
        </div>
        <% } %> <% } else { %>
        <p id="noReviewsMessage" class="text-white500 italic">
          No reviews yet. Be the first to leave one!
        </p>
        <% } %>
      </div>
    </div>
  </div>
</div>

<%-"<script>"%>
const maptilerApiKey = '<%- process.env.MAPTILER_API_KEY %>';
const place = <%- JSON.stringify(place) %>;
console.log(maptilerApiKey);
<%-"</script>"%>

<script src="/js/showPageMap.js"></script>
<script type="module" src="/js/singlePlace.js"></script>
<script type="module" src="/js/reviews.js"></script>

